#
# Copyright 2012-2014 Red Hat Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.
#

#
# Active Directory configuration. 
#
# Optional sequence setup:
# - ad_bindFormat - bind format to use, default: sam, should be set to
#   realm if sasl is used.
# - ad_principalFormat - principal format as input. default: sam, should
#   be set to realm if authn is skipped in favour of other mechanism
#   such as mod_auth_kerb5.
#

include = <common.properties>

vars.SAM_GROUP_OBJECT = 268435456
vars.SAM_NON_SECURITY_GROUP_OBJECT = 268435457
vars.SAM_ALIAS_OBJECT = 536870912
vars.SAM_NON_SECURITY_ALIAS_OBJECT = 536870913
vars.SAM_USER_OBJECT = 805306368

vars.ad-principal-record = objectGUID, sAMAccountName, displayName, memberOf, department, givenName, sn, title, mail
vars.ad-group-record = objectGUID, sAMAccountName, description, memberOf

pool.authz.auth.type = simple

attrmap.ad-map-namespace.map.nCName.alias = namespace

attrmap.map-principal-record.map.objectGUID.conversion = BASE64
attrmap.map-principal-record.map.objectGUID.alias = PrincipalRecord_ID
attrmap.map-principal-record.map.sAMAccountName.alias = PrincipalRecord_NAME
attrmap.map-principal-record.map.sAMAccountName.format = ${seq:_ad_principalAttributeFormat}
attrmap.map-principal-record.map.displayName.alias = PrincipalRecord_DISPLAY_NAME
attrmap.map-principal-record.map.memberOf.alias = PrincipalRecord_GROUPS_RAW
attrmap.map-principal-record.map.department.alias = PrincipalRecord_DEPARTMENT
attrmap.map-principal-record.map.givenName.alias = PrincipalRecord_FIRST_NAME
attrmap.map-principal-record.map.sn.alias = PrincipalRecord_LAST_NAME
attrmap.map-principal-record.map.title.alias = PrincipalRecord_TITLE
attrmap.map-principal-record.map.mail.alias = PrincipalRecord_EMAIL

attrmap.map-group-record.map.objectGUID.conversion = BASE64
attrmap.map-group-record.map.objectGUID.alias = GroupRecord_ID
attrmap.map-group-record.map.sAMAccountName.alias = GroupRecord_NAME
attrmap.map-group-record.map.description.alias = GroupRecord_DISPLAY_NAME
attrmap.map-group-record.map.memberOf.alias = GroupRecord_GROUPS_RAW

auth-check.ad-authn.pool = authn
auth-check.ad-authn.reuse-connections = true
auth-check.ad-authn.user = ${seq:_ad_bind_user}
auth-check.ad-authn.password = ${seq:password}

search.ad-rootdse.pool = authz
search.ad-rootdse.search-request.baseDN =
search.ad-rootdse.search-request.scope = BASE
search.ad-rootdse.search-request.filter = &(objectClass=*)
search.ad-rootdse.search-request.attributes = defaultNamingContext, configurationNamingContext

search.ad-domain-by-base.pool = authz
search.ad-domain-by-base.search-request.baseDN = CN=Partitions,${seq:_ad_configDN}
search.ad-domain-by-base.search-request.filter = &(objectClass=crossRef)(nCName=${seq:_ad_baseDN_encoded})(nETBIOSName=*)
search.ad-domain-by-base.search-request.attributes = nETBIOSName, nCName, dnsRoot

search.ad-domain-by-domain.pool = authz
search.ad-domain-by-domain.search-request.baseDN = CN=Partitions,${seq:_ad_configDN}
search.ad-domain-by-domain.search-request.filter = &(objectClass=crossRef)(nETBIOSName=${seq:_ad_domain_candidate_encoded})(nCName=*)
search.ad-domain-by-domain.search-request.attributes = nETBIOSName, nCName, dnsRoot

search.ad-domain-by-realm.pool = authz
search.ad-domain-by-realm.search-request.baseDN = CN=Partitions,${seq:_ad_configDN}
search.ad-domain-by-realm.search-request.filter = &(objectClass=crossRef)(dnsRoot=${seq:_ad_realm_encoded})(nETBIOSName=*)(nCName=*)
search.ad-domain-by-realm.search-request.attributes = nETBIOSName, nCName, dnsRoot

search.ad-mapping-sam.pool = authz
search.ad-mapping-sam.search-request.baseDN = ${seq:_ad_baseDN}
search.ad-mapping-sam.search-request.filter = &(sAMAccountType=${global:vars.SAM_USER_OBJECT})(sAMAccountName=${seq:_ad_user_encoded})
search.ad-mapping-sam.search-request.attributes = ${global:vars.ad-principal-record}
search.ad-mapping-sam.attrmap = map-principal-record

search.ad-namespace.pool = authz
search.ad-namespace.search-request.baseDN = CN=Partitions,${seq:_ad_configDN}
search.ad-namespace.search-request.filter = &(objectClass=crossRef)(nETBIOSName=*)
search.ad-namespace.search-request.attributes = nCName
search.ad-namespace.attrmap = ad-map-namespace

search.ad-query-principals.pool = authz
search.ad-query-principals.search-request.baseDN = ${seq:namespace}
search.ad-query-principals.search-request.filter = &(sAMAccountType=805306368)${seq:filter}
search.ad-query-principals.search-request.attributes = ${global:vars.ad-principal-record}
search.ad-query-principals.attrmap = map-principal-record

search.ad-query-groups.pool = authz
search.ad-query-groups.search-request.baseDN = ${seq:_ad_baseDN}
search.ad-query-groups.search-request.scope = ${seq:_ad_scope}
search.ad-query-groups.search-request.filter = &(|(sAMAccountType=${global:vars.SAM_GROUP_OBJECT})(sAMAccountType=${global:vars.SAM_NON_SECURITY_GROUP_OBJECT})(sAMAccountType=${global:vars.SAM_ALIAS_OBJECT})(sAMAccountType=${global:vars.SAM_NON_SECURITY_ALIAS_OBJECT}))${seq:filter}
search.ad-query-groups.search-request.attributes = ${global:vars.ad-group-record}
search.ad-query-groups.attrmap = map-group-record

auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_525 = CREDENTIALS_INVALID
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_52e = CREDENTIALS_INCORRECT
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_52f = ACCOUNT_RESTRICTION
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_530 = ACCOUNT_TIME_VIOLATION
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_531 = ACCOUNT_RESTRICTION
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_532 = CREDENTIALS_EXPIRED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_533 = ACCOUNT_DISABLED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_701 = ACCOUNT_EXPIRED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_773 = CREDENTIALS_EXPIRED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C090334_775 = ACCOUNT_LOCKED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_525 = CREDENTIALS_INVALID
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_52e = CREDENTIALS_INCORRECT
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_52f = ACCOUNT_RESTRICTION
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_530 = ACCOUNT_TIME_VIOLATION
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_531 = ACCOUNT_RESTRICTION
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_532 = CREDENTIALS_EXPIRED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_533 = ACCOUNT_DISABLED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_701 = ACCOUNT_EXPIRED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_773 = CREDENTIALS_EXPIRED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.DSID-0C0903C5_775 = ACCOUNT_LOCKED
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS._comment = http://ldapwiki.willeke.com/wiki/Microsoft%20Response%20Codes
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.translation.pattern = ^(?<code>[0-9A-Fa-f]+): LdapErr: (?<err>[^, ]+), comment: (?<comment>[^,]+), data (?<data>[0-9A-Fa-f]+), v(?<version>[0-9A-Fa-f]+)$
auth-check.default.diagnostic.mapping.INVALID_CREDENTIALS.translation.replace = ${err}_${data}

sequence-init.init.500-ad-init-vars = ad-init-vars
sequence.ad-init-vars.01.description = set principal input format to authz, sam for regular, realm for kerb sso
sequence.ad-init-vars.01.condition.type = var-set
sequence.ad-init-vars.01.condition.not = true
sequence.ad-init-vars.01.condition.var-set.variable = ad_principalFormat
sequence.ad-init-vars.01.type = var-set
sequence.ad-init-vars.01.var-set.variable = ad_principalFormat
sequence.ad-init-vars.01.var-set.value = sam
sequence.ad-init-vars.02.description = set user format: sam for basic, realm for sasl
sequence.ad-init-vars.02.condition.type = var-set
sequence.ad-init-vars.02.condition.not = true
sequence.ad-init-vars.02.condition.var-set.variable = ad_bindFormat
sequence.ad-init-vars.02.type = var-set
sequence.ad-init-vars.02.var-set.variable = ad_bindFormat
sequence.ad-init-vars.02.var-set.value = sam

sequence-init.open.500-ad-open-pools = ad-open-pools
sequence.ad-open-pools.01.description = create authz pool
sequence.ad-open-pools.01.type = pool-create
sequence.ad-open-pools.01.pool-create.name = authz
sequence.ad-open-pools.02.description = create authn pool
sequence.ad-open-pools.02.condition.type = var-set
sequence.ad-open-pools.02.condition.var-set.variable = authn_enable
sequence.ad-open-pools.02.type = pool-create
sequence.ad-open-pools.02.pool-create.name = authn

sequence-init.open.600-ad-open = ad-open-vars
sequence.ad-open-vars.01.description = root dse processing
sequence.ad-open-vars.01.type = fetch-record
sequence.ad-open-vars.01.fetch-record.search = ad-rootdse
sequence.ad-open-vars.01.fetch-record.map.defaultNamingContext.name = _ad_default_baseDN
sequence.ad-open-vars.01.fetch-record.map.configurationNamingContext.name = _ad_configDN
sequence.ad-open-vars.02.description = default domain
sequence.ad-open-vars.02.type = var-set
sequence.ad-open-vars.02.var-set.variable = _ad_baseDN
sequence.ad-open-vars.02.var-set.value = ${seq:_ad_default_baseDN}
sequence.ad-open-vars.03.description = default domain
sequence.ad-open-vars.03.type = fetch-record
sequence.ad-open-vars.03.fetch-record.search = ad-domain-by-base
sequence.ad-open-vars.03.fetch-record.map.nETBIOSName.name = _ad_default_domain
sequence.ad-open-vars.03.fetch-record.map.dnsRoot.name = _ad_default_realm

sequence.ad-set-default-domain.01.description = set default domain name
sequence.ad-set-default-domain.01.type = var-set
sequence.ad-set-default-domain.01.var-set.variable = _ad_domain
sequence.ad-set-default-domain.01.var-set.value = ${seq:_ad_default_domain}
sequence.ad-set-default-domain.02.description = set default domain dn
sequence.ad-set-default-domain.02.type = var-set
sequence.ad-set-default-domain.02.var-set.variable = _ad_baseDN
sequence.ad-set-default-domain.02.var-set.value = ${seq:_ad_default_baseDN}
sequence.ad-set-default-domain.03.type = var-set
sequence.ad-set-default-domain.03.var-set.variable = _ad_realm
sequence.ad-set-default-domain.03.var-set.value = ${seq:_ad_default_realm}

sequence.ad-set-principal-attribute-format-realm.04.description = set principal attribute conversion
sequence.ad-set-principal-attribute-format-realm.04.type = var-set
sequence.ad-set-principal-attribute-format-realm.04.var-set.variable = _ad_principalAttributeFormat
sequence.ad-set-principal-attribute-format-realm.04.var-set.value = %s@${seq:_ad_realm}

sequence.ad-set-principal-attribute-format-sam.04.description = set principal attribute conversion
sequence.ad-set-principal-attribute-format-sam.04.type = var-set
sequence.ad-set-principal-attribute-format-sam.04.var-set.variable = _ad_principalAttributeFormat
sequence.ad-set-principal-attribute-format-sam.04.var-set.value = ${seq:_ad_domain}\\%s

sequence.ad-resolve-user-realm.01.description = parse user and extract domain
sequence.ad-resolve-user-realm.01.type = regex
sequence.ad-resolve-user-realm.01.regex.value = ${seq:_ad_user}
sequence.ad-resolve-user-realm.01.regex.pattern = ^(?<user>[^@]+)@(?<realm>.*)$
sequence.ad-resolve-user-realm.01.regex.replacement._ad_user = ${user}
sequence.ad-resolve-user-realm.01.regex.replacement._ad_realm = ${realm}
sequence.ad-resolve-user-realm.02.description = fetch default domain
sequence.ad-resolve-user-realm.02.condition.type = var-set
sequence.ad-resolve-user-realm.02.condition.not = true
sequence.ad-resolve-user-realm.02.condition.var-set.variable = _ad_realm
sequence.ad-resolve-user-realm.02.type = call
sequence.ad-resolve-user-realm.02.call.name = ad-set-default-domain
sequence.ad-resolve-user-realm.03.description = fetch domain base
sequence.ad-resolve-user-realm.03.condition.type = var-set
sequence.ad-resolve-user-realm.03.condition.not = true
sequence.ad-resolve-user-realm.03.condition.var-set.variable = _ad_domain
sequence.ad-resolve-user-realm.03.type = fetch-record
sequence.ad-resolve-user-realm.03.fetch-record.search = ad-domain-by-realm
sequence.ad-resolve-user-realm.03.fetch-record.map.nETBIOSName.name = _ad_domain
sequence.ad-resolve-user-realm.03.fetch-record.map.nCName.name = _ad_baseDN
sequence.ad-resolve-user-realm.03.fetch-record.map.dnsRoot.name = _ad_realm

sequence.ad-resolve-user-sam.01.description = parse user and extract domain
sequence.ad-resolve-user-sam.01.type = regex
sequence.ad-resolve-user-sam.01.regex.value = ${seq:_ad_user}
sequence.ad-resolve-user-sam.01.regex.pattern = ^(?<domain>[^\\\\]+)\\\\(?<user>.*)$
sequence.ad-resolve-user-sam.01.regex.replacement._ad_user = ${user}
sequence.ad-resolve-user-sam.01.regex.replacement._ad_domain_candidate = ${domain}
sequence.ad-resolve-user-sam.02.description = fetch domain
sequence.ad-resolve-user-sam.02.condition.type = var-set
sequence.ad-resolve-user-sam.02.condition.not = true
sequence.ad-resolve-user-sam.02.condition.var-set.variable = _ad_domain_candidate
sequence.ad-resolve-user-sam.02.type = call
sequence.ad-resolve-user-sam.02.call.name = ad-set-default-domain
sequence.ad-resolve-user-sam.03.description = fetch domain base
sequence.ad-resolve-user-sam.03.condition.type = var-set
sequence.ad-resolve-user-sam.03.condition.var-set.variable = _ad_domain_candidate
sequence.ad-resolve-user-sam.03.type = fetch-record
sequence.ad-resolve-user-sam.03.fetch-record.search = ad-domain-by-domain
sequence.ad-resolve-user-sam.03.fetch-record.map.nETBIOSName.name = _ad_domain
sequence.ad-resolve-user-sam.03.fetch-record.map.nCName.name = _ad_baseDN
sequence.ad-resolve-user-sam.03.fetch-record.map.dnsRoot.name = _ad_realm

sequence.ad-resolve-user-error.01.description = error
sequence.ad-resolve-user-error.01.type = var-set
sequence.ad-resolve-user-error.01.var-set.variable = resultCode
sequence.ad-resolve-user-error.01.var-set.value = INVALID_CREDENTIALS
sequence.ad-resolve-user-error.02.description = error
sequence.ad-resolve-user-error.02.type = var-set
sequence.ad-resolve-user-error.02.var-set.variable = authTranslatedMessage
sequence.ad-resolve-user-error.02.var-set.value = CREDENTIALS_INVALID
sequence.ad-resolve-user-error.03.description = stop
sequence.ad-resolve-user-error.03.type = stop

sequence.ad-resolve-user.01-01.description = resolve user
sequence.ad-resolve-user.01-01.type = call
sequence.ad-resolve-user.01-01.call.name = ad-resolve-user-${seq:_ad_user_format}
sequence.ad-resolve-user.01-02.description = set principal format
sequence.ad-resolve-user.01-02.type = call
sequence.ad-resolve-user.01-02.call.name = ad-set-principal-attribute-format-${seq:_ad_user_format}
sequence.ad-resolve-user.02.description = error if no _ad_domain
sequence.ad-resolve-user.02.condition.type = var-set
sequence.ad-resolve-user.02.condition.not = true
sequence.ad-resolve-user.02.condition.var-set.variable = _ad_domain
sequence.ad-resolve-user.02.type = call
sequence.ad-resolve-user.02.call.name = ad-resolve-user-error
sequence.ad-resolve-user.03.description = error if no _ad_baseDN
sequence.ad-resolve-user.03.condition.type = var-set
sequence.ad-resolve-user.03.condition.not = true
sequence.ad-resolve-user.03.condition.var-set.variable = _ad_baseDN
sequence.ad-resolve-user.03.type = call
sequence.ad-resolve-user.03.call.name = ad-resolve-user-error
sequence.ad-resolve-user.04.description = resolve user to dn
sequence.ad-resolve-user.04.type = fetch-record
sequence.ad-resolve-user.04.fetch-record.search = ad-mapping-sam
sequence.ad-resolve-user.04.fetch-record.map._dn.name = dn
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_ID.name = PrincipalRecord_ID
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_NAME.name = PrincipalRecord_NAME
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_DISPLAY_NAME.name = PrincipalRecord_DISPLAY_NAME
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_GROUPS_RAW.name = PrincipalRecord_GROUPS_RAW
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_GROUPS_RAW.select = -1
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_DEPARTMENT.name = PrincipalRecord_DEPARTMENT
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_FIRST_NAME.name = PrincipalRecord_FIRST_NAME
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_LAST_NAME.name = PrincipalRecord_LAST_NAME
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_TITLE.name = PrincipalRecord_TITLE
sequence.ad-resolve-user.04.fetch-record.map.PrincipalRecord_EMAIL.name = PrincipalRecord_EMAIL
sequence.ad-resolve-user.05.description = error if no dn
sequence.ad-resolve-user.05.condition.type = var-set
sequence.ad-resolve-user.05.condition.not = true
sequence.ad-resolve-user.05.condition.var-set.variable = dn
sequence.ad-resolve-user.05.type = call
sequence.ad-resolve-user.05.call.name = ad-resolve-user-error

sequence.authn.01.description = copy user
sequence.authn.01.type = var-set
sequence.authn.01.var-set.variable = _ad_user
sequence.authn.01.var-set.value = ${seq:user}
sequence.authn.02.description = set user format
sequence.authn.02.type = var-set
sequence.authn.02.var-set.variable = _ad_user_format
sequence.authn.02.var-set.value = ${seq:ad_bindFormat}
sequence.authn.03.description = resolve user
sequence.authn.03.type = call
sequence.authn.03.call.name = ad-resolve-user
sequence.authn.04.description = determine which user to use for bind
sequence.authn.04.condition.type = compare
sequence.authn.04.condition.compare.left = ${seq:ad_bindFormat}
sequence.authn.04.condition.compare.right = sam
sequence.authn.04.type = var-set
sequence.authn.04.var-set.variable = _ad_bind_user
sequence.authn.04.var-set.value = ${seq:_ad_domain}\\${seq:_ad_user}
sequence.authn.05.description = determine which user to use for bind
sequence.authn.05.condition.type = compare
sequence.authn.05.condition.compare.left = ${seq:ad_bindFormat}
sequence.authn.05.condition.compare.right = realm
sequence.authn.05.type = var-set
sequence.authn.05.var-set.variable = _ad_bind_user
sequence.authn.05.var-set.value = ${seq:_ad_user}@${seq:_ad_realm}
sequence.authn.06.description = auth check
sequence.authn.06.type = auth-check
sequence.authn.06.auth-check.name = ad-authn

sequence.namespace.01.description = namespace search
sequence.namespace.01.type = search-open
sequence.namespace.01.search-open.search = ad-namespace
sequence.namespace.01.search-open.variable = query

sequence.resolve-principal.01.description = copy principal
sequence.resolve-principal.01.type = var-set
sequence.resolve-principal.01.var-set.variable = _ad_user
sequence.resolve-principal.01.var-set.value = ${seq:PrincipalRecord_NAME}
sequence.resolve-principal.02.description = set user format
sequence.resolve-principal.02.type = var-set
sequence.resolve-principal.02.var-set.variable = _ad_user_format
sequence.resolve-principal.02.var-set.value = ${seq:ad_principalFormat}
sequence.resolve-principal.03.description = resolve principal
sequence.resolve-principal.03.type = call
sequence.resolve-principal.03.call.name = ad-resolve-user

sequence.resolve-group.01.description = set base dn
sequence.resolve-group.01.type = var-set
sequence.resolve-group.01.var-set.variable = _ad_baseDN
sequence.resolve-group.01.var-set.value = ${seq:dn}
sequence.resolve-group.02.description = set scope
sequence.resolve-group.02.type = var-set
sequence.resolve-group.02.var-set.variable = _ad_scope
sequence.resolve-group.02.var-set.value = BASE
sequence.resolve-group.03.description = fetch group
sequence.resolve-group.03.type = fetch-record
sequence.resolve-group.03.fetch-record.search = ad-query-groups
sequence.resolve-group.03.fetch-record.map._dn.name = dn
sequence.resolve-group.03.fetch-record.map.GroupRecord_ID.name = GroupRecord_ID
sequence.resolve-group.03.fetch-record.map.GroupRecord_NAME.name = GroupRecord_NAME
sequence.resolve-group.03.fetch-record.map.GroupRecord_DISPLAY_NAME.name = GroupRecord_DISPLAY_NAME
sequence.resolve-group.03.fetch-record.map.GroupRecord_GROUPS_RAW.name = GroupRecord_GROUPS_RAW
sequence.resolve-group.03.fetch-record.map.GroupRecord_GROUPS_RAW.select = -1

sequence.query-principals.01.description = set base as namespace
sequence.query-principals.01.type = var-set
sequence.query-principals.01.var-set.variable = _ad_baseDN
sequence.query-principals.01.var-set.value = ${seq:namespace}
sequence.query-principals.02.description = resolve domain
sequence.query-principals.02.type = fetch-record
sequence.query-principals.02.fetch-record.search = ad-domain-by-base
sequence.query-principals.02.fetch-record.map.nETBIOSName.name = _ad_domain
sequence.query-principals.02.fetch-record.map.dnsRoot.name = _ad_realm
sequence.query-principals.03.description = stop if no domain
sequence.query-principals.03.condition.type = var-set
sequence.query-principals.03.condition.not = true
sequence.query-principals.03.condition.var-set.variable = _ad_domain
sequence.query-principals.03.type = stop
sequence.query-principals.04.description = set principal format
sequence.query-principals.04.type = call
sequence.query-principals.04.call.name = ad-set-principal-attribute-format-${seq:ad_principalFormat}
sequence.query-principals.05.description = query principals
sequence.query-principals.05.type = search-open
sequence.query-principals.05.search-open.search = ad-query-principals
sequence.query-principals.05.search-open.variable = query

sequence.query-groups.01.description = set base dn
sequence.query-groups.01.type = var-set
sequence.query-groups.01.var-set.variable = _ad_baseDN
sequence.query-groups.01.var-set.value = ${seq:namespace}
sequence.query-groups.02.description = set scope
sequence.query-groups.02.type = var-set
sequence.query-groups.02.var-set.variable = _ad_scope
sequence.query-groups.02.var-set.value = SUB
sequence.query-groups.03.description = query groups
sequence.query-groups.03.type = search-open
sequence.query-groups.03.search-open.search = ad-query-groups
sequence.query-groups.03.search-open.variable = query
